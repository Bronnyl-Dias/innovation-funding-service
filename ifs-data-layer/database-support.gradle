ext.sqlContainer = "ifs-database"
ext.testSchema = "ifs_test"
ext.dockerComposeFile = "docker-compose/docker-compose.yml"

task startMySql(type: Exec) {
    workingDir '../../'
    doFirst {
        commandLine 'docker-compose', '-p', 'innovation-funding-service', '-f', dockerComposeFile, 'up', '-d', sqlContainer
    }
    doLast {
        exec {
            //wait for sql container to start.
            //TODO need better method of waiting for startup.
            workingDir '.'
            commandLine 'sleep', '10'
        }
    }
}

task createTestSchema(type: Exec) {
    workingDir '../../'
    doFirst {
        commandLine 'docker-compose', '-p', 'innovation-funding-service', '-f', dockerComposeFile, 'exec', '-T', sqlContainer, 'mysql', '-uroot', '-ppassword', '-e', 'create database if not exists ' + testSchema
    }
}

task initDB {
    createTestSchema.mustRunAfter startMySql

    dependsOn startMySql
    dependsOn createTestSchema
}
def targetBuild = hasProperty('profile') ? profile : 'docker';
apply from: targetBuild + "-build.gradle";
apply plugin: 'org.asciidoctor.convert'
apply from: rootProject.file("gradle-support/java-spring-boot.gradle")
apply from: rootProject.file("gradle-support/openshift-build.gradle")
apply from: rootProject.file("gradle-support/prepare-docker.gradle")

ext {
    snippetsDir = file('build/generated-snippets')
}

dependencies {
    compile project(":ifs-commons")
    compile project(":ifs-sil-resources")
    compile project(":ifs-security")

    compile "org.springframework.boot:spring-boot-starter-web"
    compile 'javax.mail:mail:1.4.7'
    testCompile "org.springframework.restdocs:spring-restdocs-mockmvc:1.1.2.RELEASE"
    testCompile project(":ifs-commons").sourceSets.test.output
}

test {
    outputs.dir snippetsDir
    if (project.hasProperty('excludeTests')) {
        exclude "${project.excludeTests}"
    }

    if (project.hasProperty('testGroups')) {
        systemProperty 'testGroups', project.getProperty('testGroups')
    }
    finalizedBy asciidoctor
}

prepareDockerBaseInput {
    inputs.file("$rootProject.projectDir/ifs-commons/build/classes")
    inputs.file("$rootProject.projectDir/ifs-sil-resources/build/classes")
    inputs.file("$rootProject.projectDir/ifs-security/build/classes")

    dependsOn ":ifs-commons:build"
    dependsOn ":ifs-sil-resources:build"
    dependsOn ":ifs-security:build"

}


asciidoctor {
    attributes 'snippets': snippetsDir
    backends 'html5'
    inputs.dir snippetsDir
    outputs.dir file("static/docs")

    doLast {
        copy {
            from "build/asciidoc/html5"
            into 'static/docs'
        }
    }
}

task asciidoctorOnly(type: Test) {
    beforeTest { desc ->
        println "Executing test ${desc.className}.${desc.name}"
    }
    useJUnit {
        includeCategories 'org.innovateuk.ifs.ControllerTest'
    }
    finalizedBy asciidoctor
}

buildDocker.dependsOn ":docker:app-base-image:buildDocker"
buildDocker.dependsOn prepareDockerBaseInput

buildDocker.inputDir = project.file("$project.buildDir/docker")

osStageRemote.onlyIf { isNotProductionEnv() }

project.version = silStubVersion
tagDocker.tag = silStubVersion
osStageRemote.tag = silStubVersion
tagDockerLocal.tag = silStubVersion
osStageLocal.tag = silStubVersion

createContainer.hostName = "sil-stub"
createContainer.containerName = "sil-stub"
createContainer.containerId = "sil-stub"
createContainer.portBindings = ['8091:8080']

def enabled = project.hasProperty('initialise') ? project.property('initialise').toBoolean() : false
[stop, removeContainer, createContainer, deploy, wait].each { task ->
    task.enabled = enabled
}
